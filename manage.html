<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Flashcards</title>
  <link rel="stylesheet" href="manage.css">
  <link rel="stylesheet" href="manage-theme.css">
  <style>
    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: #f3f4f6;
      border-radius: 10px;
      margin: 0 48px 20px 48px;
    }

    .nav-tab {
      flex: 1;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #6b7280;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .nav-tab:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .nav-tab.active {
      background: white;
      color: #3b82f6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Home View Styles */
    .home-view {
      display: none;
      padding: 0 48px 48px 48px;
    }

    .home-view.active {
      display: block;
    }

    .decks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .deck-card {
      position: relative;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 16px;
      padding: 24px;
      min-height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .deck-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
      pointer-events: none;
    }

    .deck-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .deck-card.pinned::after {
      content: 'üìå';
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 16px;
      opacity: 0.9;
      z-index: 2;
    }

    .deck-due-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(239, 68, 68, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      z-index: 2;
    }

    .deck-load-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      z-index: 2;
    }

    .deck-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    .deck-emoji {
      font-size: 32px;
      line-height: 1;
      flex-shrink: 0;
    }

    .deck-info {
      flex: 1;
      min-width: 0;
    }

    .deck-name {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin: 0 0 4px 0;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .deck-description {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .deck-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
      position: relative;
      z-index: 1;
    }

    .deck-stats {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .deck-card-count {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.95);
      font-weight: 500;
    }

    .deck-last-reviewed {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.75);
    }

    .deck-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .new-deck-card {
      background: transparent;
      border: 3px dashed #cbd5e1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .new-deck-card::before {
      display: none;
    }

    .new-deck-card:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
      transform: translateY(-2px);
    }

    .new-deck-icon {
      font-size: 48px;
      color: #94a3b8;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .new-deck-card:hover .new-deck-icon {
      color: #3b82f6;
      transform: scale(1.1);
    }

    .new-deck-text {
      font-size: 16px;
      font-weight: 600;
      color: #64748b;
      transition: all 0.3s ease;
    }

    .new-deck-card:hover .new-deck-text {
      color: #3b82f6;
    }

    /* Cards View */
    .cards-view {
      display: none;
    }

    .cards-view.active {
      display: block;
    }

    /* Deck Modal */
    .deck-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    .deck-modal-backdrop.show {
      display: flex;
    }

    .deck-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 520px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .deck-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .deck-modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
    }

    .deck-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .deck-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
    }

    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .emoji-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .emoji-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: scale(1.05);
    }

    .emoji-btn.active {
      border-color: #3b82f6;
      background: #dbeafe;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .color-palette {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 10px;
    }

    .color-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 3px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .color-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .color-btn.active {
      border-color: white;
      box-shadow: 0 0 0 2px #1f2937, 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
    }

    .color-btn.active::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 16px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      color: #1f2937;
      transition: all 0.2s ease;
      outline: none;
    }

    .form-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #6b7280;
    }

    .btn-large {
      width: 100%;
      padding: 12px 32px;
      font-size: 15px;
    }

    @media (max-width: 768px) {
      .nav-tabs {
        margin: 0 20px 20px 20px;
      }

      .home-view {
        padding: 0 20px 20px 20px;
      }

      .decks-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="header-left">
          <svg class="logo" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5"></path>
            <path d="M2 12l10 5 10-5"></path>
          </svg>
          <div>
            <h1>AddFlashcard Manager</h1>
            <p class="subtitle" id="headerSubtitle">Home</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-success" id="exportApkgBtn" title="Export to Anki Package">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            Export APKG
          </button>
          <button class="btn btn-primary" id="syncAnkiBtn" title="Sync to Anki via AnkiConnect">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Sync to Anki
          </button>
          <button class="btn btn-secondary" id="exportBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export JSON
          </button>
          <button class="btn btn-secondary" id="importBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Import JSON
          </button>
        </div>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" id="homeTab">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Home
      </button>
      <button class="nav-tab" id="cardsTab">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        <span id="cardsTabLabel">All Cards</span>
      </button>
    </div>

    <!-- Home View -->
    <div class="home-view active" id="homeView">
      <div class="decks-grid" id="decksGrid">
        <!-- Deck cards will be inserted here -->
      </div>
    </div>

    <!-- Cards View -->
    <div class="cards-view" id="cardsView">
      <div class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar-left">
          <div class="deck-list-header">
            <h2>Decks</h2>
            <button class="icon-btn" id="addDeckBtn" title="Add new deck">+</button>
          </div>
          
          <div class="deck-list" id="deckList">
            <div class="deck-loading">Loading decks...</div>
          </div>
        </aside>

        <!-- Cards Area -->
        <main class="cards-area">
          <div class="cards-header">
            <div class="cards-header-left">
              <h2 id="currentDeckName">All Cards</h2>
              <span class="card-count" id="cardCount">0 cards</span>
            </div>
            <div class="cards-header-right">
              <input type="search" class="search-input" id="searchInput" placeholder="Search cards...">
              <select class="filter-select" id="tagFilter">
                <option value="">All Tags</option>
              </select>
              <select class="sort-select" id="sortSelect">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
                <option value="front">Front A-Z</option>
              </select>
              <button class="btn btn-primary" id="studyModeBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                Study Mode
              </button>
              <button class="btn btn-danger" id="deleteAllBtn">Delete All</button>
            </div>
          </div>

          <div class="cards-grid" id="cardsGrid">
            <div class="cards-loading">
              <div class="spinner"></div>
              <p>Loading cards...</p>
            </div>
          </div>

          <div class="empty-state" id="emptyState" style="display: none;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            <h3>No cards yet</h3>
            <p>Start adding flashcards to see them here</p>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Deck Modal (for create/edit) -->
  <div class="deck-modal-backdrop" id="deckModalBackdrop">
    <div class="deck-modal">
      <div class="deck-modal-header">
        <h3 id="deckModalTitle">Create deck</h3>
        <button class="modal-close" id="deckModalClose">Close</button>
      </div>

      <div class="deck-modal-body">
        <!-- Emoji Picker -->
        <div class="form-group">
          <div class="emoji-picker">
            <button class="emoji-btn active" data-emoji="üòä">üòä</button>
            <button class="emoji-btn" data-emoji="üìö">üìö</button>
            <button class="emoji-btn" data-emoji="üéì">üéì</button>
            <button class="emoji-btn" data-emoji="üí°">üí°</button>
            <button class="emoji-btn" data-emoji="üöÄ">üöÄ</button>
            <button class="emoji-btn" data-emoji="‚ö°">‚ö°</button>
            <button class="emoji-btn" data-emoji="üî¨">üî¨</button>
            <button class="emoji-btn" data-emoji="üé®">üé®</button>
            <button class="emoji-btn" data-emoji="üåü">üåü</button>
            <button class="emoji-btn" data-emoji="üéØ">üéØ</button>
            <button class="emoji-btn" data-emoji="üèÜ">üèÜ</button>
            <button class="emoji-btn" data-emoji="üìñ">üìñ</button>
          </div>
        </div>

        <!-- Deck Name -->
        <div class="form-group">
          <label for="deckNameInput">Name your deck (e.g. BIOCHEM101)</label>
          <input 
            type="text" 
            class="form-input" 
            id="deckNameInput" 
            placeholder="Enter deck name"
            maxlength="50"
          >
        </div>

        <!-- Deck Description -->
        <div class="form-group">
          <label for="deckDescInput">Description (e.g. Cards for Sem 2)</label>
          <input 
            type="text" 
            class="form-input" 
            id="deckDescInput" 
            placeholder="Enter description (optional)"
            maxlength="100"
          >
        </div>

        <!-- Color Picker -->
        <div class="form-group">
          <label>Color</label>
          <div class="color-palette">
            <button class="color-btn" data-color="#ef4444" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"></button>
            <button class="color-btn" data-color="#ec4899" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);"></button>
            <button class="color-btn" data-color="#a855f7" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);"></button>
            <button class="color-btn" data-color="#8b5cf6" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"></button>
            <button class="color-btn" data-color="#3b82f6" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></button>
            <button class="color-btn" data-color="#06b6d4" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);"></button>
            <button class="color-btn" data-color="#14b8a6" style="background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);"></button>
            <button class="color-btn active" data-color="#10b981" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></button>
            <button class="color-btn" data-color="#84cc16" style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);"></button>
            <button class="color-btn" data-color="#f59e0b" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></button>
            <button class="color-btn" data-color="#f97316" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"></button>
            <button class="color-btn" data-color="#f43f5e" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);"></button>
            
            <button class="color-btn" data-color="#fb7185" style="background: linear-gradient(135deg, #fb7185 0%, #f43f5e 100%);"></button>
            <button class="color-btn" data-color="#fb923c" style="background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);"></button>
            <button class="color-btn" data-color="#a78bfa" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);"></button>
            <button class="color-btn" data-color="#22d3ee" style="background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);"></button>
            <button class="color-btn" data-color="#2dd4bf" style="background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);"></button>
            <button class="color-btn" data-color="#4ade80" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);"></button>
            <button class="color-btn" data-color="#facc15" style="background: linear-gradient(135deg, #facc15 0%, #eab308 100%);"></button>
            <button class="color-btn" data-color="#94a3b8" style="background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);"></button>
          </div>
        </div>

        <!-- Pinned Option -->
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="deckPinnedCheckbox">
            <span>Pinned</span>
          </label>
          <small>Pinned decks appear at the top</small>
        </div>
      </div>

      <div class="deck-modal-footer">
        <button class="btn btn-primary btn-large" id="deckModalSave">Create</button>
      </div>
    </div>
  </div>

  <!-- Other modals from original manage.html ... -->
  <!-- (Keep all existing modals: editModal, previewModal, editSidebar, apkgModal, ankiModal) -->

  <input type="file" id="importFileInput" accept=".json" style="display: none;">

  <script src="vendor/jszip.min.js"></script>
  <script src="vendor/sql-wasm.js"></script>
  <script src="media-handler.js"></script>
  <script src="apkg-exporter.js"></script>
  <script src="anki-connect.js"></script>
  <script src="manage.js"></script>
  <script>
    // Integrated Home Manager Logic
    class IntegratedManager {
      constructor() {
        this.currentView = 'home';
        this.currentDeckId = null;
        this.selectedEmoji = 'üòä';
        this.selectedColor = '#10b981';
        this.editingDeckId = null;
        
        this.init();
      }

      init() {
        // Check URL params
        const params = new URLSearchParams(window.location.search);
        const deckParam = params.get('deck');
        
        if (deckParam) {
          this.currentDeckId = deckParam;
          this.switchToCardsView();
        } else {
          this.switchToHomeView();
        }

        this.bindEvents();
        this.loadDecks();
      }

      bindEvents() {
        // Tab switching
        document.getElementById('homeTab')?.addEventListener('click', () => {
          this.switchToHomeView();
        });

        document.getElementById('cardsTab')?.addEventListener('click', () => {
          this.switchToCardsView();
        });

        // Deck modal
        document.getElementById('deckModalClose')?.addEventListener('click', () => {
          this.hideDeckModal();
        });

        document.getElementById('deckModalBackdrop')?.addEventListener('click', (e) => {
          if (e.target.id === 'deckModalBackdrop') {
            this.hideDeckModal();
          }
        });

        // Emoji selection
        document.querySelectorAll('.emoji-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            this.selectedEmoji = btn.getAttribute('data-emoji');
          });
        });

        // Color selection
        document.querySelectorAll('.color-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            this.selectedColor = btn.getAttribute('data-color');
          });
        });

        // Save deck
        document.getElementById('deckModalSave')?.addEventListener('click', () => {
          this.saveDeck();
        });

        // Add deck button (in sidebar)
        document.getElementById('addDeckBtn')?.addEventListener('click', () => {
          this.showDeckModal();
        });
      }

      switchToHomeView() {
        this.currentView = 'home';
        this.currentDeckId = null;
        
        document.getElementById('homeTab')?.classList.add('active');
        document.getElementById('cardsTab')?.classList.remove('active');
        document.getElementById('homeView')?.classList.add('active');
        document.getElementById('cardsView')?.classList.remove('active');
        document.getElementById('headerSubtitle').textContent = 'Home';
        
        // Update URL
        history.pushState({}, '', 'manage.html');
        
        this.loadDecks();
      }

      switchToCardsView(deckId = null) {
        this.currentView = 'cards';
        if (deckId) {
          this.currentDeckId = deckId;
        }
        
        document.getElementById('homeTab')?.classList.remove('active');
        document.getElementById('cardsTab')?.classList.add('active');
        document.getElementById('homeView')?.classList.remove('active');
        document.getElementById('cardsView')?.classList.add('active');
        
        // Update URL and tab label
        if (this.currentDeckId) {
          history.pushState({}, '', `manage.html?deck=${this.currentDeckId}`);
          chrome.storage.local.get(['decks'], (result) => {
            const deck = result.decks?.[this.currentDeckId];
            if (deck) {
              document.getElementById('cardsTabLabel').textContent = deck.name;
              document.getElementById('headerSubtitle').textContent = deck.name;
            }
          });
        } else {
          history.pushState({}, '', 'manage.html?view=cards');
          document.getElementById('cardsTabLabel').textContent = 'All Cards';
          document.getElementById('headerSubtitle').textContent = 'All Cards';
        }
        
        // Trigger original manage.js to load cards
        if (window.manageApp) {
          window.manageApp.loadCards();
        }
      }

      async loadDecks() {
        if (this.currentView !== 'home') return;

        try {
          const result = await chrome.storage.local.get(['decks', 'cards']);
          const decks = result.decks || {};
          const cards = result.cards || [];

          const decksGrid = document.getElementById('decksGrid');
          if (!decksGrid) return;

          decksGrid.innerHTML = '';

          const deckArray = Object.entries(decks).map(([id, deck]) => ({
            id,
            ...deck,
            cardCount: cards.filter(c => c.deck === id).length,
            newCards: cards.filter(c => c.deck === id && !c.lastReviewed).length,
            dueCards: this.getDueCards(cards.filter(c => c.deck === id))
          }));

          // Sort: pinned first
          deckArray.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return (b.lastModified || 0) - (a.lastModified || 0);
          });

          deckArray.forEach(deck => {
            const deckCard = this.createDeckCard(deck);
            decksGrid.appendChild(deckCard);
          });

          // Add new deck card
          const newDeckCard = document.createElement('div');
          newDeckCard.className = 'deck-card new-deck-card';
          newDeckCard.innerHTML = `
            <div style="text-align: center;">
              <div class="new-deck-icon">+</div>
              <div class="new-deck-text">New deck</div>
            </div>
          `;
          newDeckCard.addEventListener('click', () => this.showDeckModal());
          decksGrid.appendChild(newDeckCard);

        } catch (error) {
          console.error('Error loading decks:', error);
        }
      }

      createDeckCard(deck) {
        const card = document.createElement('div');
        card.className = 'deck-card';
        if (deck.pinned) card.classList.add('pinned');

        const color = deck.color || '#10b981';
        card.style.background = `linear-gradient(135deg, ${color} 0%, ${this.darkenColor(color, 20)} 100%)`;

        let statusIcon = 'üìù';
        let statusText = 'Empty';
        if (deck.cardCount === 0) {
          statusIcon = 'üìù';
          statusText = 'Empty';
        } else if (deck.newCards > 0) {
          statusIcon = 'üìö';
          statusText = `${deck.newCards} new`;
        } else if (deck.dueCards > 0) {
          statusIcon = '‚è∞';
          statusText = `${deck.dueCards} due`;
        } else {
          statusIcon = '‚úì';
          statusText = 'Up to date';
        }

        let dueBadge = '';
        if (deck.dueCards > 0) {
          dueBadge = `<div class="deck-due-badge">${deck.dueCards} Due</div>`;
        }

        let loadBadge = '';
        if (deck.newCards > 0) {
          loadBadge = `<div class="deck-load-badge">Load</div>`;
        }

        let lastReviewed = 'Never studied';
        if (deck.lastReviewed) {
          const daysAgo = Math.floor((Date.now() - deck.lastReviewed) / (1000 * 60 * 60 * 24));
          if (daysAgo === 0) lastReviewed = 'Studied today';
          else if (daysAgo === 1) lastReviewed = 'Last studied yesterday';
          else lastReviewed = `Last studied ${daysAgo} days ago`;
        }

        card.innerHTML = `
          ${dueBadge}
          ${loadBadge}
          <div class="deck-header">
            <div class="deck-emoji">${deck.emoji || 'üìö'}</div>
            <div class="deck-info">
              <h3 class="deck-name">${this.escapeHtml(deck.name)}</h3>
              ${deck.description ? `<p class="deck-description">${this.escapeHtml(deck.description)}</p>` : ''}
            </div>
          </div>
          <div class="deck-footer">
            <div class="deck-stats">
              <div class="deck-card-count">${deck.cardCount} card${deck.cardCount !== 1 ? 's' : ''}</div>
              <div class="deck-last-reviewed">${lastReviewed}</div>
            </div>
            <div class="deck-status">
              <span>${statusIcon}</span>
              ${statusText}
            </div>
          </div>
        `;

        card.addEventListener('click', () => {
          this.currentDeckId = deck.id;
          this.switchToCardsView(deck.id);
        });

        return card;
      }

      showDeckModal(deckId = null) {
        const modal = document.getElementById('deckModalBackdrop');
        const title = document.getElementById('deckModalTitle');
        const saveBtn = document.getElementById('deckModalSave');
        const nameInput = document.getElementById('deckNameInput');
        const descInput = document.getElementById('deckDescInput');
        const pinnedCheckbox = document.getElementById('deckPinnedCheckbox');

        this.editingDeckId = deckId;

        if (deckId) {
          chrome.storage.local.get(['decks'], (result) => {
            const deck = result.decks?.[deckId];
            if (!deck) return;

            title.textContent = 'Edit deck';
            saveBtn.textContent = 'Save';
            nameInput.value = deck.name || '';
            descInput.value = deck.description || '';
            pinnedCheckbox.checked = deck.pinned || false;

            this.selectedEmoji = deck.emoji || 'üòä';
            this.selectedColor = deck.color || '#10b981';
            
            document.querySelectorAll('.emoji-btn').forEach(btn => {
              btn.classList.toggle('active', btn.getAttribute('data-emoji') === this.selectedEmoji);
            });
            document.querySelectorAll('.color-btn').forEach(btn => {
              btn.classList.toggle('active', btn.getAttribute('data-color') === this.selectedColor);
            });
          });
        } else {
          title.textContent = 'Create deck';
          saveBtn.textContent = 'Create';
          nameInput.value = '';
          descInput.value = '';
          pinnedCheckbox.checked = false;

          this.selectedEmoji = 'üòä';
          this.selectedColor = '#10b981';
          
          document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-emoji') === this.selectedEmoji);
          });
          document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-color') === this.selectedColor);
          });
        }

        modal.classList.add('show');
        nameInput.focus();
      }

      hideDeckModal() {
        document.getElementById('deckModalBackdrop')?.classList.remove('show');
        this.editingDeckId = null;
      }

      async saveDeck() {
        const nameInput = document.getElementById('deckNameInput');
        const descInput = document.getElementById('deckDescInput');
        const pinnedCheckbox = document.getElementById('deckPinnedCheckbox');

        const name = nameInput.value.trim();
        if (!name) {
          alert('Please enter a deck name');
          nameInput.focus();
          return;
        }

        const deckData = {
          name,
          description: descInput.value.trim(),
          emoji: this.selectedEmoji,
          color: this.selectedColor,
          pinned: pinnedCheckbox.checked,
          lastModified: Date.now()
        };

        try {
          const result = await chrome.storage.local.get(['decks']);
          const decks = result.decks || {};

          if (this.editingDeckId) {
            decks[this.editingDeckId] = {
              ...decks[this.editingDeckId],
              ...deckData
            };
          } else {
            const deckId = 'deck_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            decks[deckId] = {
              ...deckData,
              created: Date.now()
            };
          }

          await chrome.storage.local.set({ decks });

          this.hideDeckModal();
          this.loadDecks();

          // Reload sidebar in cards view
          if (window.manageApp) {
            window.manageApp.loadDecks();
          }

        } catch (error) {
          console.error('Error saving deck:', error);
          alert('Failed to save deck');
        }
      }

      getDueCards(cards) {
        const now = Date.now();
        return cards.filter(card => {
          if (!card.lastReviewed) return false;
          const nextReview = card.lastReviewed + (card.interval || 1) * 24 * 60 * 60 * 1000;
          return nextReview <= now;
        }).length;
      }

      darkenColor(hex, percent) {
        const num = parseInt(hex.replace('#', ''), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.max((num >> 16) - amt, 0);
        const G = Math.max((num >> 8 & 0x00FF) - amt, 0);
        const B = Math.max((num & 0x0000FF) - amt, 0);
        return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Initialize
    window.integratedManager = new IntegratedManager();
  </script>
</body>
</html>
