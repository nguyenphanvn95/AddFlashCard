<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APKG Exporter Demo - AddFlashcard v2.3.0</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .section h2 {
      color: #444;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }
    
    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .cards-list {
      margin-top: 15px;
    }
    
    .card-item {
      background: white;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-content {
      flex: 1;
    }
    
    .card-front {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .card-back {
      font-size: 13px;
      color: #666;
    }
    
    .btn-remove {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .btn-remove:hover {
      background: #dc2626;
    }
    
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      text-align: center;
      font-size: 13px;
      color: #666;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      display: none;
    }
    
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¥ APKG Exporter Demo</h1>
    <p class="subtitle">Test the APKG export functionality - AddFlashcard v2.3.0</p>
    
    <!-- Add Card Section -->
    <div class="section">
      <h2>‚ûï Add Sample Cards</h2>
      <div class="form-group">
        <label>Front (Question)</label>
        <input type="text" id="cardFront" placeholder="Enter card front...">
      </div>
      <div class="form-group">
        <label>Back (Answer)</label>
        <textarea id="cardBack" placeholder="Enter card back..."></textarea>
      </div>
      <button class="btn-primary" onclick="addCard()">Add Card</button>
      <button class="btn-secondary" onclick="addSampleCards()">Add 5 Sample Cards</button>
      
      <div class="cards-list" id="cardsList"></div>
    </div>
    
    <!-- Export Section -->
    <div class="section">
      <h2>üì¶ Export to APKG</h2>
      <div class="form-group">
        <label>Deck Name</label>
        <input type="text" id="deckName" value="Demo Deck" placeholder="Enter deck name...">
      </div>
      <button class="btn-success" onclick="exportAPKG()" id="exportBtn">Export APKG File</button>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Exporting... 0%</div>
      </div>
      
      <div class="status" id="status"></div>
    </div>
    
    <!-- Instructions -->
    <div class="section">
      <h2>üìñ How to Use</h2>
      <ol style="padding-left: 20px; color: #555; line-height: 1.8;">
        <li>Add cards using the form above, or click "Add 5 Sample Cards"</li>
        <li>Enter a deck name (default: "Demo Deck")</li>
        <li>Click "Export APKG File"</li>
        <li>Wait for the download to complete</li>
        <li>Open Anki Desktop</li>
        <li>File ‚Üí Import ‚Üí Select the downloaded .apkg file</li>
        <li>Your cards will appear in the "Demo Deck"!</li>
      </ol>
    </div>
  </div>
  
  <!-- Load required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  
  <script>
    let cards = [];
    let SQL_INSTANCE = null;
    
    // Initialize sql.js
    async function initSQL() {
      if (!SQL_INSTANCE) {
        SQL_INSTANCE = await initSqlJs({
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });
      }
    }
    
    // Add a card
    function addCard() {
      const front = document.getElementById('cardFront').value.trim();
      const back = document.getElementById('cardBack').value.trim();
      
      if (!front || !back) {
        alert('Please fill in both front and back!');
        return;
      }
      
      cards.push({ front, back });
      document.getElementById('cardFront').value = '';
      document.getElementById('cardBack').value = '';
      
      renderCards();
    }
    
    // Add sample cards
    function addSampleCards() {
      const samples = [
        { front: 'Hello', back: 'A greeting used when meeting someone' },
        { front: 'Goodbye', back: 'A farewell expression' },
        { front: 'Thank you', back: 'Expression of gratitude' },
        { front: 'Please', back: 'Polite request word' },
        { front: 'Sorry', back: 'Apology expression' }
      ];
      
      cards.push(...samples);
      renderCards();
    }
    
    // Remove a card
    function removeCard(index) {
      cards.splice(index, 1);
      renderCards();
    }
    
    // Render cards list
    function renderCards() {
      const list = document.getElementById('cardsList');
      
      if (cards.length === 0) {
        list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No cards yet. Add some cards to get started!</p>';
        return;
      }
      
      list.innerHTML = cards.map((card, index) => `
        <div class="card-item">
          <div class="card-content">
            <div class="card-front">${card.front}</div>
            <div class="card-back">${card.back}</div>
          </div>
          <button class="btn-remove" onclick="removeCard(${index})">Remove</button>
        </div>
      `).join('');
    }
    
    // Simple checksum
    function sha1ish(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = ((h << 5) - h + str.charCodeAt(i)) | 0;
      }
      return Math.abs(h);
    }
    
    // Export to APKG
    async function exportAPKG() {
      if (cards.length === 0) {
        showStatus('Please add some cards first!', 'error');
        return;
      }
      
      const deckName = document.getElementById('deckName').value.trim() || 'Demo Deck';
      const btn = document.getElementById('exportBtn');
      const progress = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      try {
        btn.disabled = true;
        btn.textContent = 'Exporting...';
        progress.style.display = 'block';
        hideStatus();
        
        // Initialize SQL
        await initSQL();
        
        const nowMs = Date.now();
        const nowSec = Math.floor(nowMs / 1000);
        const modelId = nowMs;
        const deckId = nowMs + 1;
        
        const db = new SQL_INSTANCE.Database();
        
        // Create tables
        db.run(`CREATE TABLE col (id INTEGER PRIMARY KEY, crt INTEGER NOT NULL, mod INTEGER NOT NULL, scm INTEGER NOT NULL, ver INTEGER NOT NULL, dty INTEGER NOT NULL, usn INTEGER NOT NULL, ls INTEGER NOT NULL, conf TEXT NOT NULL, models TEXT NOT NULL, decks TEXT NOT NULL, dconf TEXT NOT NULL, tags TEXT NOT NULL);`);
        db.run(`CREATE TABLE notes (id INTEGER PRIMARY KEY, guid TEXT NOT NULL, mid INTEGER NOT NULL, mod INTEGER NOT NULL, usn INTEGER NOT NULL, tags TEXT NOT NULL, flds TEXT NOT NULL, sfld TEXT NOT NULL, csum INTEGER NOT NULL, flags INTEGER NOT NULL, data TEXT NOT NULL);`);
        db.run(`CREATE TABLE cards (id INTEGER PRIMARY KEY, nid INTEGER NOT NULL, did INTEGER NOT NULL, ord INTEGER NOT NULL, mod INTEGER NOT NULL, usn INTEGER NOT NULL, type INTEGER NOT NULL, queue INTEGER NOT NULL, due INTEGER NOT NULL, ivl INTEGER NOT NULL, factor INTEGER NOT NULL, reps INTEGER NOT NULL, lapses INTEGER NOT NULL, left INTEGER NOT NULL, odue INTEGER NOT NULL, odid INTEGER NOT NULL, flags INTEGER NOT NULL, data TEXT NOT NULL);`);
        db.run(`CREATE TABLE revlog (id INTEGER PRIMARY KEY, cid INTEGER NOT NULL, usn INTEGER NOT NULL, ease INTEGER NOT NULL, ivl INTEGER NOT NULL, lastIvl INTEGER NOT NULL, factor INTEGER NOT NULL, time INTEGER NOT NULL, type INTEGER NOT NULL);`);
        db.run(`CREATE TABLE graves (usn INTEGER NOT NULL, oid INTEGER NOT NULL, type INTEGER NOT NULL);`);
        
        // Define model
        const models = {};
        models[modelId] = {
          id: modelId,
          name: "Basic",
          type: 0,
          mod: nowSec,
          usn: -1,
          sortf: 0,
          did: deckId,
          tmpls: [{
            name: "Card 1",
            ord: 0,
            qfmt: "{{Front}}",
            afmt: "{{FrontSide}}<hr id=answer>{{Back}}",
            bqfmt: "",
            bafmt: "",
            did: null,
            bfont: "",
            bsize: 0,
            id: 0
          }],
          flds: [
            { name: "Front", ord: 0, sticky: false, rtl: false, font: "Arial", size: 20 },
            { name: "Back", ord: 1, sticky: false, rtl: false, font: "Arial", size: 20 }
          ],
          css: `.card {
  font-family: arial;
  font-size: 20px;
  text-align: center;
  color: black;
  background-color: white;
}`,
          latexPre: "",
          latexPost: "",
          latexsvg: false,
          req: [[0, "all", [0]]]
        };
        
        // Create deck
        const decks = {
          "1": { id: 1, mod: 0, name: "Default", usn: 0, lrnToday: [0,0], revToday: [0,0], newToday: [0,0], timeToday: [0,0], collapsed: true, browserCollapsed: true, desc: "", dyn: 0, conf: 1, extendNew: 0, extendRev: 0 }
        };
        decks[String(deckId)] = {
          id: deckId,
          mod: nowSec,
          name: deckName,
          usn: -1,
          lrnToday: [0,0],
          revToday: [0,0],
          newToday: [0,0],
          timeToday: [0,0],
          collapsed: false,
          browserCollapsed: false,
          desc: "",
          dyn: 0,
          conf: 1,
          extendNew: 0,
          extendRev: 0
        };
        
        const conf = {
          schedVer: 2,
          curDeck: deckId,
          curModel: modelId,
          activeDecks: [deckId],
          newSpread: 0,
          collapseTime: 1200,
          timeLim: 0,
          estTimes: true,
          dueCounts: true,
          sortType: "noteFld",
          sortBackwards: false,
          addToCur: true,
          dayLearnFirst: false,
          creationOffset: -420
        };
        
        const dconf = {
          1: {
            id: 1,
            mod: 0,
            name: "Default",
            usn: 0,
            maxTaken: 60,
            autoplay: true,
            timer: 0,
            replayq: true,
            new: { bury: false, delays: [1,10], initialFactor: 2500, ints: [1,4,0], order: 1, perDay: 20 },
            rev: { bury: false, ease4: 1.3, ivlFct: 1, maxIvl: 36500, perDay: 200, hardFactor: 1.2 },
            lapse: { delays: [10], leechAction: 1, leechFails: 8, minInt: 1, mult: 0 }
          }
        };
        
        db.run(`INSERT INTO col VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)`, [
          1, nowSec, nowSec, nowSec, 11, 0, 0, 0,
          JSON.stringify(conf),
          JSON.stringify(models),
          JSON.stringify(decks),
          JSON.stringify(dconf),
          "{}"
        ]);
        
        // Add notes and cards
        cards.forEach((card, idx) => {
          const percent = Math.round(((idx + 1) / cards.length) * 100);
          progressFill.style.width = percent + '%';
          progressText.textContent = `Exporting... ${percent}%`;
          
          const noteId = nowMs + 1000 + idx;
          const fields = [card.front, card.back];
          const sfld = card.front;
          const csum = sha1ish(sfld);
          const guid = 'g' + Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10);
          
          db.run(`INSERT INTO notes VALUES (?,?,?,?,?,?,?,?,?,?,?)`, [
            noteId, guid, modelId, nowSec, -1, "",
            fields.join('\u001f'), sfld, csum, 0, "{}"
          ]);
          
          const cardId = nowMs + 500000 + idx;
          db.run(`INSERT INTO cards VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)`, [
            cardId, noteId, deckId, 0, nowSec, -1,
            0, 0, idx + 1,
            0, 0, 0, 0, 0, 0, 0, 0, "{}"
          ]);
        });
        
        // Export database
        const data = db.export();
        const zip = new JSZip();
        zip.file("collection.anki2", data);
        zip.file("media", JSON.stringify({}));
        
        const blob = await zip.generateAsync({
          type: "blob",
          compression: "DEFLATE",
          compressionOptions: { level: 9 }
        });
        
        // Download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
        a.download = `${deckName.replace(/[^\w\-]/g,'_')}_${timestamp}_${cards.length}cards.apkg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus(`‚úÖ Successfully exported ${cards.length} cards to ${deckName}!`, 'success');
        
      } catch (error) {
        console.error('Export error:', error);
        showStatus('‚ùå Export failed: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Export APKG File';
        progress.style.display = 'none';
      }
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    // Initialize
    renderCards();
  </script>
</body>
</html>
